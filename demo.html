<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta charset="utf-8">
    <meta name = "viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link href = "css/style.css" rel = "stylesheet" >
    <script type="text/javascript" src="js/lib/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="js/lib/knockout/dist/knockout.js"></script>

    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body, .container-fluid{
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid">
      <div id="map"></div>
        <form onsubmit="submitFn(this,event);"> <!-- submitFn 功能?? -->
          <main class="search-wrapper">
           <div class="input-holder">
             <input type="text" class="input-search" placeholder="搜索景点" data-bind="value:searchText, valueUpdate:'keyup'"/>
             <button type="button" class="search-icon" onclick="searchToggle(this,event);"></button>

           </div>
           <span class="close" onclick="searchToggle(this, event);" style="opacity:1.0"></span>

           <section class="result_container">
             <ul class="" role="menu" data-bind="foreach:locationName" >
               <!-- bootstrap下拉菜单 -->
               <li calss="start">
                 <a href="#" data-bind="click:$parent.select" style="color:white;">
                   <i class="icon-pointer"> </i>
                   <span class="title" data-bind="text:title, click:$parent.select">

                   </span>
                 </a>
               </li>
             </ul>
           </section>
          </main>
        </form>
    </div>

    <script type="text/javascript">
        function searchToggle(obj,evt){
          var container = $(obj).closest('.search-wrapper');
          var result_container = $("result_container");
          if(!container.hasClass(".active")){
            container.addClass(".active");
            result_container.css({
              display: "block";
            });
            evt.preventDefault();
          }else if (container.hasClass(".active") && $(obj).closest(".input-holder").length == 0) {
            container.removeClass(".active");
            container.find(".search-input").val("");
            container.find("result_container").fadeOut(500,callback());
            result_container.css({
              display: 'none';
            });
          }
        }
        $(function callback(){
          $('#map').height($(document.body).height());
        })
    </script>





    <script>
      var map;
      var markers = [];

      var locations = [
        { title: "杭州西湖",
          location: {lat: 30.2283669051, lng: 120.1347587344}
        },{
          title: "东阳横店影视城",
          location: {lat: 29.1633936915, lng: 120.3699124044}
        },{
          title: "温州雁荡山",
          location: {lat: 28.3893538678, lng: 121.0822165504}
        },{
          title: "嘉兴南湖",
          location: {lat: 30.7607727677, lng: 120.7662067390}
        },{
          title: "钱塘江",
          location: {lat: 30.2798502718, lng: 120.2540018992}
        },{
          title: "嘉兴乌镇",
          location: {lat: 30.7554558841, lng: 120.4926867879}
        },{
          title: "西溪",
          location: {lat: 30.2752091858, lng: 120.0742896566}
        },{
          title: "千岛湖",
          location: {lat: 29.6018722016, lng: 119.0214595304}
        },{
          title: "湖州莫干山",
          location: {lat: 30.6125304250, lng: 119.8750885031}
        },{
          title: "舟山普陀",
          location: {lat: 29.9553159987, lng: 122.3092501811}
        }
      ];

      // var myLatlng = {lat: 30.245, lng: 120.162};
      // var myLatlng2 = {lat: 30.255, lng: 120.162};

      function initMap() {
        //设置map地图样式
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 30.245, lng: 120.162},
          zoom: 17,
          streetViewControl: true,
          rotateControl: true,
          zoomControl: true,
          scaleControl: true,

          mapTypeControl: true,
          mapTypeControlOptions:{
            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
            //mapTypeIds: ["roadmap","terrain"]
          }
        });

        //creat markers
        locations.forEach(function(item,index,arr){
          var marker = new google.maps.Marker({
            position:item.location,
            map:map,
            title:item.title,
            animation:google.maps.Animation.DROP
          });
          markers.push(marker);

          marker.addListener("click",function(){
            bounce(this);
            infoWindow.open(map,marker);
          });

        });

        //bounce animation
        function bounce(marker){
          marker.setAnimation(google.maps.Animation.BOUNCE);
          window.setTimeout(function(){
            marker.setAnimation(null);   //2s后标记停止bounce
          },2000)
        };

        //creat bounds 同时map会自动将视图范围包含所有markers
       function creatBounds(){
          var bounds = new google.maps.LatLngBounds();
          for (var i = 0; i < markers.length; i++) {
            bounds.extend(markers[i].position);   //extends this bounds to cotain the given point(https://developers.google.com/maps/documentation/javascript/reference?csw=1#LatLngBounds)合并markers.position至bounds--{f{f,d},b{f,d}}
          };
          map.fitBounds(bounds);   //使地图viewport对所有bounds可见
          console.log(bounds);
       };
       creatBounds();


       //加载百度地图天气API
       markers.forEach(function(item){
         var myurl = "https://api.map.baidu.com/telematics/v3/weather?location=" + item.position.lng() + "," + item.position.lat() + "&output=json&ak=b0L00kvB63P53tPEGaa9BGvypgCjV3D1";
         $.ajax({
           url: myurl,
           dataType: 'jsonp',
         })
         .done(function(data){
           if(data['results']){
             var results = data['results'],
                 current_weather = results[0]['weather_data'][0],
                 imgURL = current_weather['dayPictureUrl'],
                 weather = current_weather['weather'],
                 temp = current_weather['temperature'];
             item.extra = '<ul style =  "list-style:none;">';
             item.extra += '<img src = ">'+ imgURL +'" alt="weatherImag"/>';
             item.extra += '<li>Temperature：'+ temp + '</li>';
             item.extra += '<li>Weather：'+ weather + '</li>';
             item.extra += '</ul>';
           }else {
             item.extra = '';
           }
         })
         .fail(function () {
           alert('天气预报加载失败，请检查网络连接');
         })
         .always(function () {
           console.log('complete');
         });
       });


//ViewModel
      var ViewModel = function () {
        var self = this;
        this.locationName=ko.observableArray(locations);
        this.searchText=ko.observable("");
        this.markerItem=ko.observableArray(markers);

        this.search = function(value){
          self.locationName([]);
          for (var x in locations) {
            if (locations[x].title.toLowerCase().indexOf(value.toLowerCase()) >=0){
              self.locationName.push(locations(x));
              markers[x].setVisible(true);
            }else {
              markers[x].setVisible(false);
            };
          }
        };

        this.searchText.subscribe(self.search);   //searchText绑定search

        self.select = function () {
          for (var i = 0; i < locations.length; i++) {
            filter.push(locations[i].title);
          }
          current = filter.indexOf(this.title);
          google.maps.event.trigger(markers[current],'click')

        }


      };
      ko.applyBindings(new ViewModel());

        //设置标记
        // var marker = new google.maps.Marker({
        //   position: myLatlng,
        //   map:map,
        //   title:"title",
        //   animation:google.maps.Animation.DROP
        // });

        //设置信息窗口
        // var infoWindow = new google.maps.InfoWindow({
        //   content: "zoom:" + map.getZoom(),
        //   position: myLatlng
        // });

        //traffic层
        // var transitLayer = new google.maps.TransitLayer();
        // transitLayer.setMap(map);

        //点击标记改变map中心点和大小
        // marker.addListener("click",function(){
        //   window.setTimeout(function(){
        //     map.setZoom(19);
        //     map.setCenter(myLatlng2);
        //   },500);
        //   //infoWindow.open(map,marker);
        // });

       //map中心改变后地图panTo 重设的标记点
        // map.addListener("center_changed",function(){
        //   window.setTimeout(function(){
        //     map.panTo(marker.setPosition(myLatlng2));
        //   },3000);
        // });
     //map的zoom改变后 信息窗口信息改变
        // map.addListener("zoom_changed",function(){
        //   window.setTimeout(function(){
        //     infoWindow.setContent("zoom:" + map.getZoom());
        //   },3000);
        // });


      }

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAImIIBU0qxkhLWU5Ema38mQVFjSUMSN4w&callback=initMap"
    async defer></script>
    <script src="bootstrap/js/bootstrap.min.js">
    </script>

  </body>
</html>
